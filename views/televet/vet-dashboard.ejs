<!-- views/televet/vet-dashboard.ejs -->
<!DOCTYPE html>
<html lang="<%= userLang || 'en' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= __('Vet Dashboard - TeleVet') %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-4">
          <a href="/" class="text-2xl font-bold text-green-600">
            <i class="fas fa-leaf"></i> Aarohi
          </a>
          <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">
            <i class="fas fa-user-md"></i> <%= __('Veterinarian') %>
          </span>
        </div>
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-sm text-gray-600"><%= __('Online') %></span>
          </div>
          <span class="text-gray-700 font-medium">Dr. <%= vet.name %></span>
          <a href="/vet-auth/logout" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
            <i class="fas fa-sign-out-alt"></i> <%= __('Logout') %>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Vet Info Card -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="flex items-center">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-4xl">
          <i class="fas fa-user-md text-white"></i>
        </div>
        <div class="ml-6">
          <h2 class="text-2xl font-bold text-gray-800">Dr. <%= vet.name %></h2>
          <% if (vet.specialization) { %>
            <p class="text-gray-600 mt-1">
              <i class="fas fa-stethoscope"></i> <span class="font-medium"><%= __('Specialization') %>:</span> <%= vet.specialization %>
            </p>
          <% } %>
          <p class="text-gray-600">
            <i class="fas fa-phone"></i> <span class="font-medium"><%= __('Contact') %>:</span> <%= vet.phone %>
          </p>
        </div>
      </div>
    </div>

    <!-- Pending Calls Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-phone-volume text-blue-600 mr-2"></i>
        <%= __('Incoming Calls') %>
        <% if (pendingCalls.length > 0) { %>
          <span class="ml-2 px-2 py-1 bg-red-500 text-white text-xs rounded-full animate-pulse">
            <%= pendingCalls.length %>
          </span>
        <% } %>
      </h3>
      
      <div id="pendingCalls" class="space-y-4">
        <% if (pendingCalls.length > 0) { %>
          <% pendingCalls.forEach(call => { %>
            <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 animate-pulse-slow" data-call-id="<%= call._id %>">
              <div class="flex items-center justify-between">
                <div class="flex items-center flex-1">
                  <img src="<%= call.farmerId.profileImage %>" alt="<%= call.farmerId.name %>"
                    class="w-12 h-12 rounded-full object-cover border-2 border-blue-300">
                  <div class="ml-4">
                    <p class="font-semibold text-gray-800 text-lg"><%= call.farmerId.name %></p>
                    <p class="text-sm text-gray-600">
                      <i class="fas fa-map-marker-alt"></i> <%= call.farmerId.village %>, <%= call.farmerId.state %>
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                      <i class="fas fa-clock"></i> <%= new Date(call.createdAt).toLocaleTimeString() %>
                    </p>
                  </div>
                </div>
                <div class="flex space-x-3">
                  <button onclick="acceptCall('<%= call._id %>', '<%= call.roomId %>')" 
                    class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-check mr-2"></i> <%= __('Accept') %>
                  </button>
                  <button onclick="rejectCall('<%= call._id %>')" 
                    class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-medium shadow-md hover:shadow-lg flex items-center">
                    <i class="fas fa-times mr-2"></i> <%= __('Decline') %>
                  </button>
                </div>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="flex items-center justify-center py-12 text-gray-400">
            <div class="text-center">
              <i class="fas fa-phone-slash text-6xl mb-4"></i>
              <p class="text-lg"><%= __('No incoming calls') %></p>
              <p class="text-sm mt-2"><%= __('You will be notified when a farmer calls') %></p>
            </div>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Call History -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-history text-gray-600 mr-2"></i>
        <%= __('Recent Consultations') %>
      </h3>
      <div class="space-y-3">
        <% if (callHistory.length > 0) { %>
          <% callHistory.forEach(call => { %>
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
              <div class="flex items-center">
                <img src="<%= call.farmerId.profileImage %>" alt="<%= call.farmerId.name %>"
                  class="w-10 h-10 rounded-full object-cover">
                <div class="ml-3">
                  <p class="font-medium text-gray-800"><%= call.farmerId.name %></p>
                  <p class="text-sm text-gray-500">
                    <i class="far fa-calendar"></i> <%= new Date(call.startTime).toLocaleDateString() %>
                    <%= new Date(call.startTime).toLocaleTimeString() %>
                  </p>
                </div>
              </div>
              <div class="flex items-center space-x-4">
                <% if (call.duration) { %>
                  <span class="text-sm text-gray-600">
                    <i class="far fa-clock"></i> <%= Math.floor(call.duration / 60) %>m <%= (call.duration % 60) %>s
                  </span>
                <% } %>
                <span class="px-3 py-1 text-xs rounded-full <%= call.status === 'ended' ? 'bg-gray-200 text-gray-700' : 'bg-red-100 text-red-700' %>">
                  <%= call.status === 'ended' ? __('Completed') : __('Rejected') %>
                </span>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="text-center py-8 text-gray-400">
            <i class="fas fa-file-medical-alt text-5xl mb-3"></i>
            <p><%= __('No consultation history yet') %></p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Incoming Call Modal -->
  <div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center">
        <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
          <i class="fas fa-phone-volume text-blue-600 text-4xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2"><%= __('Incoming Call') %></h3>
        <p class="text-gray-600 mb-6" id="callerInfo"><%= __('A farmer is calling') %>...</p>
        <div class="flex space-x-4">
          <button id="acceptModalBtn" 
            class="flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition font-medium flex items-center justify-center">
            <i class="fas fa-check mr-2"></i> <%= __('Accept') %>
          </button>
          <button id="rejectModalBtn" 
            class="flex-1 bg-red-500 text-white py-3 rounded-lg hover:bg-red-600 transition font-medium flex items-center justify-center">
            <i class="fas fa-times mr-2"></i> <%= __('Decline') %>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    const vetId = '<%= vet._id %>';
    let currentCallData = null;

    // Register vet with socket
    socket.emit('register', vetId);

    // Listen for new incoming calls
    socket.on('new-call-for-vet', (callData) => {
      console.log('New call received:', callData);
      
      // Show modal
      currentCallData = callData;
      document.getElementById('callerInfo').textContent = `${callData.farmerName} is calling...`;
      document.getElementById('callModal').classList.remove('hidden');
      
      // Play notification sound (optional)
      playNotificationSound();
      
      // Add to pending calls list if not already there
      addPendingCallToList(callData);
    });

    // Modal accept button
    document.getElementById('acceptModalBtn').addEventListener('click', () => {
      if (currentCallData) {
        acceptCall(currentCallData.callId, currentCallData.roomId);
      }
    });

    // Modal reject button
    document.getElementById('rejectModalBtn').addEventListener('click', () => {
      if (currentCallData) {
        rejectCall(currentCallData.callId);
      }
      document.getElementById('callModal').classList.add('hidden');
    });

    async function acceptCall(callId, roomId) {
      try {
        const response = await fetch(`/televet/call/accept/${callId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // Redirect to call room
          window.location.href = `/televet/room/${roomId}`;
        } else {
          alert(data.message || 'Failed to accept call');
        }
      } catch (error) {
        console.error('Error accepting call:', error);
        alert('An error occurred. Please try again.');
      }
    }

    async function rejectCall(callId) {
      try {
        const response = await fetch(`/televet/call/reject/${callId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
          // Remove from pending list
          const callElement = document.querySelector(`[data-call-id="${callId}"]`);
          if (callElement) {
            callElement.remove();
          }
          
          // Check if no more pending calls
          checkNoPendingCalls();
          
          document.getElementById('callModal').classList.add('hidden');
        }
      } catch (error) {
        console.error('Error rejecting call:', error);
        alert('An error occurred');
      }
    }

    function addPendingCallToList(callData) {
      const pendingCallsContainer = document.getElementById('pendingCalls');
      const existingCall = document.querySelector(`[data-call-id="${callData.callId}"]`);
      
      if (existingCall) return; // Already in list

      // Remove "no calls" message if exists
      const noCallsMsg = pendingCallsContainer.querySelector('.text-gray-400');
      if (noCallsMsg) {
        noCallsMsg.parentElement.remove();
      }

      const callHtml = `
        <div class="border border-blue-200 bg-blue-50 rounded-lg p-4 animate-pulse-slow" data-call-id="${callData.callId}">
          <div class="flex items-center justify-between">
            <div class="flex items-center flex-1">
              <img src="${callData.farmerImage || '/images/default-user.png'}" alt="${callData.farmerName}"
                class="w-12 h-12 rounded-full object-cover border-2 border-blue-300">
              <div class="ml-4">
                <p class="font-semibold text-gray-800 text-lg">${callData.farmerName}</p>
                <p class="text-sm text-gray-600">
                  <i class="fas fa-map-marker-alt"></i> ${callData.farmerLocation || 'Location not available'}
                </p>
                <p class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString()}
                </p>
              </div>
            </div>
            <div class="flex space-x-3">
              <button onclick="acceptCall('${callData.callId}', '${callData.roomId}')" 
                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition font-medium shadow-md hover:shadow-lg flex items-center">
                <i class="fas fa-check mr-2"></i> Accept
              </button>
              <button onclick="rejectCall('${callData.callId}')" 
                class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition font-medium shadow-md hover:shadow-lg flex items-center">
                <i class="fas fa-times mr-2"></i> Decline
              </button>
            </div>
          </div>
        </div>
      `;

      pendingCallsContainer.insertAdjacentHTML('afterbegin', callHtml);
    }

    function checkNoPendingCalls() {
      const pendingCallsContainer = document.getElementById('pendingCalls');
      const calls = pendingCallsContainer.querySelectorAll('[data-call-id]');
      
      if (calls.length === 0) {
        pendingCallsContainer.innerHTML = `
          <div class="flex items-center justify-center py-12 text-gray-400">
            <div class="text-center">
              <i class="fas fa-phone-slash text-6xl mb-4"></i>
              <p class="text-lg">No incoming calls</p>
              <p class="text-sm mt-2">You will be notified when a farmer calls</p>
            </div>
          </div>
        `;
      }
    }

    function playNotificationSound() {
      // Optional: Add notification sound
      const audio = new Audio('/sounds/notification.mp3');
      audio.play().catch(e => console.log('Audio play failed:', e));
    }

    // Refresh page every 30 seconds to check for new calls (backup to socket)
    setInterval(() => {
      // Only refresh if not in a call
      if (!document.hidden) {
        location.reload();
      }
    }, 30000);
  </script>

  <style>
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
  </style>
</body>
</html>