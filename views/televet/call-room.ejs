<!-- views/televet/call-room.ejs -->
<!DOCTYPE html>
<html lang="<%= userLang || 'en' %>">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= __('Video Call') %> - TeleVet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    video {
      transform: scaleX(-1); /* Mirror effect */
    }
    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #localVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body class="bg-gray-900 overflow-hidden">
  <!-- Config element with all EJS variables and i18n strings -->
    <div id="callConfig" style="display:none"
      data-room-id="<%= roomId %>"
      data-user-id="<%= userId %>"
      data-user-name="<%= userName %>"
      data-user-role="<%= userRole %>"
      data-other-name="<%= (typeof userRole !== 'undefined' && userRole === 'farmer') ? (call && call.vetId ? (call.vetId.name || '') : '') : (call && call.farmerId ? (call.farmerId.name || '') : '') %>"
       data-connecting-text="<%= __('Connecting') %>"
       data-connected-text="<%= __('Connected') %>"
       data-creating-connection-text="<%= __('Creating connection') %>"
       data-accepting-call-text="<%= __('Accepting call') %>"
       data-connection-lost-text="<%= __('Connection Lost') %>"
       data-user-disconnected-text="<%= __('User disconnected') %>"
       data-user-left-text="<%= __('User left') %>"
       data-waiting-text="<%= __('Waiting for other participant') %>"
       data-you-text="<%= __('You') %>"
       data-toggle-video-text="<%= __('Toggle Video') %>"
       data-toggle-audio-text="<%= __('Toggle Audio') %>"
       data-end-call-text="<%= __('End Call') %>"
       data-switch-camera-text="<%= __('Switch Camera') %>"
       data-end-call-confirm="<%= __('Are you sure you want to end this call?') %>"
       data-media-error="<%= __('Could not access camera/microphone. Please check permissions.') %>"
       data-vet-with-text="<%= __('with') %>"
        data-televet-text="<%= __('TeleVet Consultation') %>">
  </div>

  <div class="h-screen flex flex-col">
    <!-- Header -->
    <div class="bg-gray-800 text-white px-6 py-3 flex justify-between items-center z-10">
      <div class="flex items-center space-x-3">
        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
        <span class="font-medium text-sm" id="connectionStatus"></span>
      </div>
      <div class="text-center flex-1">
        <h1 class="text-lg font-bold">
          <i class="fas fa-video"></i> <span id="consultationTitle"></span>
        </h1>
        <p class="text-xs text-gray-400" id="consultationSubtitle"></p>
      </div>
      <div class="text-right">
        <span class="text-sm text-gray-300">
          <i class="fas fa-user"></i> <span id="userNameDisplay"></span>
        </span>
      </div>
    </div>

    <!-- Video Container -->
    <div class="flex-1 relative">
      <!-- Remote Video (Full Screen) -->
      <div class=\"absolute inset-0 bg-gray-800\">
        <video id=\"remoteVideo\" autoplay playsinline></video>
        
        <!-- Waiting Message -->
        <div id=\"waitingMessage\" class=\"absolute inset-0 flex items-center justify-center bg-gray-800\">
          <div class=\"text-center text-white\">
            <div class=\"w-24 h-24 bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4\">
              <i class=\"fas fa-user text-5xl text-gray-500\"></i>
            </div>
            <p class=\"text-xl font-medium\" id=\"waitingText\"></p>
            <div class=\"mt-4\">
              <div class=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-white\"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Local Video (Picture in Picture) -->
      <div class="absolute top-4 right-4 w-48 h-36 md:w-64 md:h-48 bg-gray-700 rounded-lg overflow-hidden shadow-2xl border-2 border-gray-600 z-20">
        <video id="localVideo" autoplay muted playsinline></video>
        <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 px-2 py-1 rounded text-white text-xs">
          <i class="fas fa-user"></i> <span id="localVideoLabel"></span>
        </div>
        <div id="localVideoOff" class="hidden absolute inset-0 bg-gray-800 flex items-center justify-center">
          <i class="fas fa-video-slash text-white text-3xl"></i>
        </div>
      </div>

      <!-- Call Timer -->
      <div class="absolute top-4 left-4 bg-black bg-opacity-60 px-4 py-2 rounded-lg text-white z-20">
        <i class="fas fa-clock"></i> <span id="callTimer">00:00</span>
      </div>

      <!-- Controls -->
      <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-4 z-20">
        <!-- Toggle Video -->
        <button id="toggleVideo" onclick="toggleVideo()" 
          class="bg-gray-700 hover:bg-gray-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"
          title="">
          <i id="videoIcon" class="fas fa-video text-xl"></i>
        </button>
        
        <!-- Toggle Audio -->
        <button id="toggleAudio" onclick="toggleAudio()" 
          class="bg-gray-700 hover:bg-gray-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"
          title="">
          <i id="audioIcon" class="fas fa-microphone text-xl"></i>
        </button>
        
        <!-- End Call -->
        <button onclick="endCall()" 
          class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-full shadow-lg transition font-medium transform hover:scale-110"
          title="">
          <i class="fas fa-phone-slash mr-2"></i> <span id="endCallText"></span>
        </button>
        
        <!-- Switch Camera (mobile) -->
        <button id="switchCamera" onclick="switchCamera()" 
          class="bg-gray-700 hover:bg-gray-600 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110 md:hidden"
          title="">
          <i class="fas fa-sync-alt text-xl"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Read configuration from data element
    const configEl = document.getElementById('callConfig');
    const config = configEl.dataset;
    
    const socket = io();
    const roomId = config.roomId;
    const userId = config.userId;
    const userName = config.userName;
    const userRole = config.userRole;

    // i18n strings from data attributes
    const i18n = {
      connecting: config.connectingText,
      connected: config.connectedText,
      creatingConnection: config.creatingConnectionText,
      acceptingCall: config.acceptingCallText,
      connectionLost: config.connectionLostText,
      userDisconnected: config.userDisconnectedText,
      waiting: config.waitingText,
      youText: config.youText,
      endCallConfirm: config.endCallConfirm,
      mediaError: config.mediaError,
      televet: config.televetText
    };

    // Set initial UI labels
    document.getElementById('connectionStatus').textContent = i18n.connecting + '...';
    document.getElementById('consultationTitle').textContent = i18n.televet;
    document.getElementById('userNameDisplay').textContent = userName;
    document.getElementById('localVideoLabel').textContent = i18n.youText;
    document.getElementById('endCallText').textContent = config.endCallText;
    document.getElementById('waitingText').textContent = i18n.waiting + '...';
    document.getElementById('toggleVideo').title = config.toggleVideoText;
    document.getElementById('toggleAudio').title = config.toggleAudioText;
    document.getElementById('switchCamera').title = config.switchCameraText;

    // Set consultation subtitle (with other participant)
    const otherName = config.otherName || '';
    if (otherName) {
      const joinText = i18n.vetWithText || 'with';
      if (userRole === 'farmer') {
        document.getElementById('consultationSubtitle').textContent = `${joinText} Dr. ${otherName}`;
      } else {
        document.getElementById('consultationSubtitle').textContent = `${joinText} ${otherName}`;
      }
    }

    let localStream = null;
    let remoteStream = null;
    let peerConnection = null;
    let isVideoEnabled = true;
    let isAudioEnabled = true;
    let currentFacingMode = 'user';
    let callStartTime = null;
    let timerInterval = null;
    let roomJoined = false;
    let roomReadyResolve = null;
    const roomReadyPromise = new Promise(resolve => {
      roomReadyResolve = resolve;
    });

    const configuration = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' }
      ]
    };

    // Initialize media and WebRTC
    async function init() {
      try {
        // Request permissions and get local media stream
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        document.getElementById('localVideo').srcObject = localStream;
        console.log('Local stream acquired');

        // Setup peer connection BEFORE joining room
        setupPeerConnection();

        // Register user with socket
        socket.emit('register', userId);
        console.log('[TeleVet] Registered user:', userId);

        // Join the call room and wait for confirmation
        socket.emit('televet-join-room', {
          roomId,
          userId,
          userName,
          userRole
        });
        console.log('[TeleVet] Join room event emitted, waiting for confirmation...');

        // Wait for room ready signal
        await roomReadyPromise;
        console.log('[TeleVet] Room ready, peer connection established');

      } catch (error) {
        console.error('Error accessing media devices or joining room:', error);
        alert(i18n.mediaError);
        redirectToDashboard();
      }
    }

    function setupPeerConnection() {
      peerConnection = new RTCPeerConnection(configuration);
      console.log('Peer connection created');

      // Add local stream tracks to peer connection
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
        console.log('Added track:', track.kind);
      });

      // Handle incoming tracks
      peerConnection.ontrack = (event) => {
        console.log('Remote track received:', event.track.kind);
        if (!remoteStream) {
          remoteStream = new MediaStream();
          document.getElementById('remoteVideo').srcObject = remoteStream;
          document.getElementById('waitingMessage').style.display = 'none';
          document.getElementById('connectionStatus').textContent = i18n.connected;
          
          // Start call timer
          if (!callStartTime) {
            callStartTime = Date.now();
            startCallTimer();
          }
        }
        remoteStream.addTrack(event.track);
      };

      // Handle ICE candidates
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log('Sending ICE candidate:', event.candidate.candidate.substring(0, 50) + '...');
          socket.emit('televet-ice-candidate', {
            roomId,
            candidate: event.candidate
          });
        } else {
          console.log('ICE gathering completed');
        }
      };

      // Monitor connection state
      peerConnection.onconnectionstatechange = () => {
        console.log('Connection state:', peerConnection.connectionState);
        const status = peerConnection.connectionState;
        
        if (status === 'connected') {
          document.getElementById('connectionStatus').textContent = i18n.connected;
        } else if (status === 'disconnected' || status === 'failed') {
          document.getElementById('connectionStatus').textContent = i18n.connectionLost;
        } else if (status === 'connecting') {
          document.getElementById('connectionStatus').textContent = i18n.connecting + '...';
        }
      };

      peerConnection.oniceconnectionstatechange = () => {
        console.log('ICE connection state:', peerConnection.iceConnectionState);
      };

      peerConnection.onsignalingstatechange = () => {
        console.log('Signaling state:', peerConnection.signalingState);
      };

      peerConnection.onerror = (event) => {
        console.error('Peer connection error:', event);
        document.getElementById('connectionStatus').textContent = 'Connection Error';
      };
    }

    // Socket event handlers
    socket.on('televet-user-joined', async (data) => {
      console.log('User joined:', data);
      
      if (data.userId !== userId) {
        document.getElementById('connectionStatus').textContent = i18n.creatingConnection + '...';
        
        try {
          // Create and send offer
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          
          socket.emit('televet-offer', {
            roomId,
            offer
          });
          console.log('Offer created and sent');
        } catch (error) {
          console.error('Error creating offer:', error);
          document.getElementById('connectionStatus').textContent = 'Error: ' + error.message;
        }
      }
    });

    socket.on('televet-offer', async (data) => {
      console.log('Received offer');
      document.getElementById('connectionStatus').textContent = i18n.acceptingCall + '...';
      
      try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        socket.emit('televet-answer', {
          roomId,
          answer
        });
        console.log('Answer created and sent');
      } catch (error) {
        console.error('Error handling offer:', error);
        document.getElementById('connectionStatus').textContent = 'Error: ' + error.message;
      }
    });

    socket.on('televet-answer', async (data) => {
      console.log('Received answer');
      try {
        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        console.log('Remote description set successfully');
      } catch (error) {
        console.error('Error handling answer:', error);
        document.getElementById('connectionStatus').textContent = 'Error: ' + error.message;
      }
    });

    socket.on('televet-ice-candidate', async (data) => {
      try {
        if (peerConnection.remoteDescription) {
          await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
          console.log('ICE candidate added');
        } else {
          console.warn('Remote description not set yet, buffering ICE candidate');
        }
      } catch (error) {
        console.error('Error adding ICE candidate:', error);
      }
    });

    socket.on('televet-user-left', () => {
      console.log('User left');
      document.getElementById('waitingMessage').style.display = 'flex';
      document.getElementById('connectionStatus').textContent = i18n.userDisconnected;
      
      if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
      }
    });

    // Room ready signal - confirms peer connection can proceed
    socket.on('televet-room-ready', ({ roomId, participants }) => {
      console.log('[TeleVet] Room ready confirmed with', participants, 'participant(s)');
      roomJoined = true;
      roomReadyResolve();
    });

    // Both participants ready - additional confirmation
    socket.on('televet-both-ready', ({ message }) => {
      console.log('[TeleVet]', message);
      document.getElementById('connectionStatus').textContent = 'Initializing...';
    });

    // Control functions
    function toggleVideo() {
      isVideoEnabled = !isVideoEnabled;
      localStream.getVideoTracks()[0].enabled = isVideoEnabled;
      
      const videoIcon = document.getElementById('videoIcon');
      const toggleBtn = document.getElementById('toggleVideo');
      const localVideoOff = document.getElementById('localVideoOff');
      
      if (isVideoEnabled) {
        videoIcon.className = 'fas fa-video text-xl';
        toggleBtn.classList.remove('bg-red-600');
        toggleBtn.classList.add('bg-gray-700');
        localVideoOff.classList.add('hidden');
      } else {
        videoIcon.className = 'fas fa-video-slash text-xl';
        toggleBtn.classList.remove('bg-gray-700');
        toggleBtn.classList.add('bg-red-600');
        localVideoOff.classList.remove('hidden');
      }
    }

    function toggleAudio() {
      isAudioEnabled = !isAudioEnabled;
      localStream.getAudioTracks()[0].enabled = isAudioEnabled;
      
      const audioIcon = document.getElementById('audioIcon');
      const toggleBtn = document.getElementById('toggleAudio');
      
      if (isAudioEnabled) {
        audioIcon.className = 'fas fa-microphone text-xl';
        toggleBtn.classList.remove('bg-red-600');
        toggleBtn.classList.add('bg-gray-700');
      } else {
        audioIcon.className = 'fas fa-microphone-slash text-xl';
        toggleBtn.classList.remove('bg-gray-700');
        toggleBtn.classList.add('bg-red-600');
      }
    }

    async function switchCamera() {
      try {
        // Stop current video track
        localStream.getVideoTracks().forEach(track => track.stop());
        
        // Switch facing mode
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        
        // Get new video stream
        const newStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode },
          audio: false
        });
        
        const newVideoTrack = newStream.getVideoTracks()[0];
        
        // Replace video track in local stream
        const oldVideoTrack = localStream.getVideoTracks()[0];
        localStream.removeTrack(oldVideoTrack);
        localStream.addTrack(newVideoTrack);
        
        // Update video element
        document.getElementById('localVideo').srcObject = localStream;
        
        // Replace track in peer connection
        const sender = peerConnection.getSenders().find(s => s.track.kind === 'video');
        if (sender) {
          sender.replaceTrack(newVideoTrack);
        }
      } catch (error) {
        console.error('Error switching camera:', error);
      }
    }

    async function endCall() {
      const confirmed = confirm(i18n.endCallConfirm);
      if (!confirmed) return;

      // Stop all tracks
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }
      if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
      }

      // Close peer connection
      if (peerConnection) {
        peerConnection.close();
      }

      // Leave room
      socket.emit('televet-leave-room', roomId);

      // Stop timer
      if (timerInterval) {
        clearInterval(timerInterval);
      }

      // Update call status in database
      try {
        await fetch(`/televet/call/end/${roomId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
      } catch (error) {
        console.error('Error ending call:', error);
      }

      // Redirect back to dashboard
      redirectToDashboard();
    }

    function redirectToDashboard() {
      if (userRole === 'farmer') {
        window.location.href = '/televet/vets';
      } else {
        window.location.href = '/televet/vet/dashboard';
      }
    }

    function startCallTimer() {
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - callStartTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        document.getElementById('callTimer').textContent = 
          `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }, 1000);
    }

    // Handle page unload/refresh
    window.addEventListener('beforeunload', (e) => {
      endCall();
    });

    // Handle visibility change (tab switch)
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('Tab hidden - call continues in background');
      }
    });

    // Initialize on page load
    window.addEventListener('load', () => {
      init();
    });
  </script>
</body>
</html>